<div class="container">
  <h2>Create Invoice</h2>
  <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
    <div class="row">
      <div class="col-md-6">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Customer Name</mat-label>
          <input matInput formControlName="customerName" required>
          <mat-error *ngIf="invoiceForm.get('customerName')?.hasError('required')">
            Customer name is required
          </mat-error>
        </mat-form-field>
      </div>
      <div class="col-md-6">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Invoice Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="invoiceDate">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <h3>Items</h3>
    <div formArrayName="invoiceItems" class="mb-3">
      <div *ngFor="let item of invoiceItems.controls; let i = index" [formGroupName]="i">
        <div class="row align-items-center">
          <div class="col-md-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Item</mat-label>
              <mat-select formControlName="itemId" (selectionChange)="onItemChange(i)">
                <mat-option *ngFor="let item of items" [value]="item.itemId">
                  {{item.name}} ({{item.stockQuantity}} available)
                </mat-option>
              </mat-select>
              <mat-error *ngIf="invoiceItems.at(i).get('itemId')?.hasError('required')">
                Item is required
              </mat-error>
            </mat-form-field>
          </div>
          <div class="col-md-2">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Quantity</mat-label>
              <input matInput type="number" formControlName="quantity" 
                     (change)="calculateLineTotal(i)" min="1">
              <mat-error *ngIf="invoiceItems.at(i).get('quantity')?.hasError('required')">
                Quantity is required
              </mat-error>
              <mat-error *ngIf="invoiceItems.at(i).get('quantity')?.hasError('min')">
                Must be at least 1
              </mat-error>
            </mat-form-field>
          </div>
          <div class="col-md-2">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Unit Price</mat-label>
              <input matInput formControlName="unitPrice" readonly>
            </mat-form-field>
          </div>
          <div class="col-md-2">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Total</mat-label>
              <input matInput formControlName="total" readonly>
            </mat-form-field>
          </div>
          <div class="col-md-2">
            <button mat-icon-button color="warn" type="button" (click)="removeItem(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <button mat-raised-button type="button" color="primary" (click)="addItem()">
      Add Item
    </button>

    <div class="total-section mt-3">
      <h3>Grand Total: {{grandTotal | currency}}</h3>
    </div>

    <div class="actions mt-4">
      <button mat-raised-button color="primary" type="submit" 
              [disabled]="invoiceForm.invalid || invoiceItems.length === 0">
        Save Invoice
      </button>
    </div>
  </form>
</div>